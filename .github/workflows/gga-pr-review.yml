name: GGA PR Review

on:
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read

concurrency:
  group: gga-pr-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  gga-review:
    name: GGA review (PR mode)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install GGA
        run: |
          git clone https://github.com/Gentleman-Programming/gentleman-guardian-angel.git /tmp/gga
          chmod +x /tmp/gga/bin/gga
          echo "/tmp/gga/bin" >> "$GITHUB_PATH"

      - name: Show GGA version
        run: gga version

      - name: Prepare base branch for PR mode
        run: |
          BASE_BRANCH="${{ github.event.pull_request.base.ref || 'main' }}"
          echo "Using PR base branch: ${BASE_BRANCH}"
          git fetch origin "${BASE_BRANCH}:${BASE_BRANCH}" --depth=1

      - name: Run GGA in PR mode
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GGA_PROVIDER: github:gpt-4o
          PR_BASE_BRANCH: ${{ github.event.pull_request.base.ref || 'main' }}
        run: gga run --pr-mode --diff-only
